# 2020年10月

## 2020/10/05

* 阅读文献 Neural networks in time-optimal low-thrust interplanetary transfers 结合海洋师兄博士论文

    主要内容：训练神经网络作为预测器和控制器，学习小推力时间最优转移问题的最优转移时间、协态初值、最优控制律。

* 阅读文献 Interplanetary transfers via deep representations of the optimal policy and/or of the value function

    主要内容：

    1. 生成数据集，通过一条轨迹附近添加摄动，直接获取满足最优性的数据集，不需要反复求解最优控制问题。

    2. 根据HJB方程，用于预测优化指标的神经网络进行求导也可以计算最优控制律，但需要在loss函数中添加惩罚项，才可以达到较高的精度。

    但是文中没有提到如何根据神经网络计算优化指标对于当前状态的导数。

* 一些感受

    机器学习的目的在于预测未知，这两篇文章都在针对某一特定问题进行求解，生成数据集，然后进行训练，最终说明可以用神经网络来学习输入和输出之间的关系，但是**这一关系仍然只针对这一问题**，如地球转移到与火星交会时间最优、地球转移到金星轨道燃料最优。

    数据集包含的范围应该更加广泛，类似于海洋师兄Deep Networks那篇文章，初始质量、初始状态、末端状态都作为输入，并且在一个范围内变化，才能够用于**多目标问题的全局优化**中。

    只针对单一问题的神经网络训练**状态变量-控制变量对**，可能适合应用到具体某一任务的**实时最优控制**上，如着陆问题。

## 2020/10/06

* 高等动力学

    复习广义能量积分、广义动量积分、第一类拉格朗日方程。

    作业

    上课

* 阅读文献 Automated solution of the low-thrust interplanetary trajectory problem

    主要内容：采用双层循环算法，外层采用null-gene technique+GA选择访问序列和引力辅助序列，内层用MBH+NLP直接法优化时间节点和控制律

    内层循环每次都采用直接法进行计算，没有实现进行筛选或给出较好的初值，需要花费非常多的时间。

## 2020/10/07

* 上课 航天动力学

* 生成GTOC7小推力时间最优数据集，搭建神经网络进行训练

    共生成100000条数据，80000用作训练集，10000用作验证集，10000用作测试集。

    输入量为：出发天体的经典轨道根数6个；目标天体的经典轨道根数6个；初始质量1个

    输出量为：最优转移时间1个

    目前训练结果平均相对误差可以达到4%

    可以改变的地方：真实天体/虚拟天体生成数据集；增加/改变输入量

## 2020/10/08

* 神经网络训练

    激活函数采用Sigmoid效果很差。

    下一步需要进行超参数的搜索

* 批改航天动力学作业

## 2020/10/09

* 讨论班 陈诗雨/鄂智博

* 神经网络超参数调节

    超参数搜索：batch_size num_layers num_neurons

    采用不同的激活函数

    自适应学习率

## 2020/10/10

* 机器学习

    请教程林师兄，C++如何调用python训练好的神经网络？网络上的方法比较繁琐，计划是**将神经网络中的参数输出，然后在C++中手动搭建网络，并实现ReLU激活函数**。

    目前平均相对误差可以达到2%左右，但对于单条数据的最大误差超过400%。

    如何提高预测精度？检查生成数据集时的程序有没有问题、继续扩大神经网络的规模、扩大超参数搜索的范围。

    将初始学习率加入到超参数随机搜索中去。

* 应用训练好的神经网络求解序列优化问题

    读取GTOC7小行星数据、神经网络模型数据

    C++通过神经网络模型进行运算，估计最优时间，估计结果与python估计结果不同，程序中可能存在问题，`temp`在中间层计算过程中会发生改变，影响后续的计算，因此需要新建一个`new_temp`变量，目前已修改正确。

* 观察相对误差的分布情况

    大部分都集中在很小的范围内，有一些误差较大，最大误差约为500%，后续需要更详细的观察。

## 2020/10/11

* 相对误差

    对相对误差进行分析，找出相对误差很大的那些坏点，分析是不是间接法计算错误。

    当天没有进行。

## 2020/10/12

* 高等动力学

    复习第一类拉格朗日方程：笛卡尔坐标形式、广义坐标形式、上课例题回顾（平面冰刀、斜面冰刀、平面多体问题）

    复习刚体动力学基础：方向余弦矩阵

    作业：平面运动刚体质心的速度时遇到一些困难，如果采用对x、y方向的直角坐标求导的方式进行计算，后续的推导会变得非常复杂，如果采用速度合成，用余弦定理进行计算，就可以得到比较简单的形式。

* 航天动力学

    计算作业题前两题

## 2020/10/13

* 航天动力学

    计算后三个作业题，使用实验室已有的C++函数。

    批改作业，计算错误和公式错误较多，导致最后结果错误。

* 高等动力学

    上课

## 2020/10/14

* 航天动力学

    上课

    金鑫答疑 根据直角坐标位置速度判断真近点角的象限

* 多目标时间最优序列

    神经网络预测最优转移时间+集束搜索，最短的时间内访问 10 颗小行星。

    根节点为所有偏心率满足条件的小行星，共4986个。

    在进行拓展时，每一个节点，找出这条序列没有被访问过的小行星，然后全部进行拓展，最后对同一层的所有新节点进行排序，按照设置的集束宽度进行保留。

    在进行第一次拓展时，产生的新节点个数为4986\*4985=24855210个节点，数量非常多；后续每一层拓展时，产生的新节点个数也非常多，假设集束宽度为10000，新节点个数为10000\*4900=4.9e7。

    如何减少内存占用？

    生成数据集时，规定两颗小行星的半长轴和轨道倾角之差不能太大，出发时刻的真经度之差也不能太大，在集束搜索当中也加入这一约束。

    加入这一约束之后，新节点个数仍然很多，必须对每个节点产生的新节点个数进行限制，引入brachfactor，每个父节点产生的所有子节点进行排序，只保留branchfactor个。

    采用beamwidth=10，branchfactor=100，进行简单测试，第一步花费较长时间，后续由于beamwidth=10，计算速度很快。

    从计算结果来看，程序中存在一个小问题，神经网络预测的结果是归一化时间，应该转化为天数，有一处忘了转换，改进之后重新进行计算。

    * 随机搜索超参数、生成数据集、集束搜索，程序运行时间较长，运行期间做些什么？
    
        读文献？使用GA、ACO等做一些简单的算例？

    * 间接法对于该问题进行优化时，应该如何进行？
    
        在确定序列后，每一步计算时间最优？多段一起优化？

* 全局优化过程中需要考虑的问题

    优化算法的选择

    缩减搜索空间：快速/精度要求低

    快速/较为准确的估计指标

    最终的局部优化算法：直接法、间接法

* 航天动力学

    两点边值问题作业，第二题题目不太明确

* 高等动力学

    复习虚功率原理：用第二类拉格朗日方程和虚功率原理分别求解椭圆摆问题。
    
    作业：虚功率原理推导三维刚体动力学方程。

## 2020/10/15

* 组会

* 张永隆 Ryugu程序调试

    主函数需要参数，应该从什么地方输入？命令行/项目属性中设置

    Ryugu.obj和C++程序不匹配，导致索引超出范围报错。

    python程序中的bpy模块只能在blender软件中调用

* 阅读文献

    Izzo的两篇会议论文中提到最大初始质量问题，始终满推。

    最大初始质量适当减小，是否能够实现交会？

    两篇都是会议论文，质量较差。

* 检查数据中的坏点

    发现生成数据集的程序中存在问题：

    1. 重复求解10次，仅以最后一次是否成功作为评判指标。为了保证数据集的可靠性，应该只保留每一次都成功的解，如果其中有一次不成功，那就舍弃掉。

    2. 另一个问题是，在一次求解结束后，没有对`Out`数组进行归零重置，导致如果中间某次求解失败，仍然会输出上一次成功的值。

* 大程序运行

	目前还有两个程序需要运行：重新生成数据集、集束搜索。

## 2020/10/16

* 五院项目

    优化算法模块：遗传算法、序列二次规划、粒子群、蚁群。首先应用于简单的函数极值问题，阐述优缺点，后续可以应用到轨迹优化当中，如直接法、多脉冲。

    轨迹优化模块：小推力 - 直接法/间接法，允许一段时间内推力不发生改变的次优解；最优脉冲机动 - 脉冲数目、大小、时间。

    最优脉冲数量？

    轨迹优化的任务类型有两个：交会、轨道转移。

    考虑摄动和地影区。

* 讨论班 - 武迪

* 阅读文献 Review of optimization methodologies in global and China trajectory optimization competitions

    模型简化、全局优化算法、局部优化算法

## 2020/10/17

* 遗传算法学习

    使用遗传算法求解一元函数极大值，遗传算法的主要步骤包括编码、选择、交叉、变异等，每一步都有多种方式可选。

    在进化过程中，每一步在一定的概率下才会发生交叉和变异，因此可能下一代相比与上一代并没有发生改变。

    遗传算法应该将每一代的最优个体都进行保留。

    * 编码：二进制编码、普通浮点数

    * 选择：随机选择、轮盘赌选择。交叉的两个父代一般采用轮盘赌选择，突变个体采用随机选择

    * 交叉：如果采用二进制编码，一般是选择一个节点进行交叉；如果采用浮点数表示，新个体的变量值为两个父代的加权平均。

        替换策略 - 产生两个新个体之后的处理方法：

        1. 在交叉完之后，舍弃父代，只保留子代；

        2. 从两个父代、两个子代共四个个体中保留最好的两个。

    * 变异：二进制编码，随机翻转一个编码或者交换两个编码；浮点数，重新随机给定一个值

    遗传算法在总体思想不变的情况下，可以调整的具体细节很多，在网上查到很多不同的版本。

## 2020/10/19

* 遗传算法

    Matlab编程 - 遗传算法求解一元函数极大值问题

    * 采用二进制编码，需要给定自变量的上下限和离散精度

    * 在每一代中，从上一代种群中，采用轮盘赌的方式选择两个父代个体，然后进行交叉，产生两个子代个体，选择较好的一个进入下一代种群，直到下一代种群个数达到`NP`

        在交叉的过程中，有一个交叉概率，当随机数小于交叉概率时，才进行交叉；如果随机数大于交叉概率，则不进行交叉，直接让较好的一个父代个体进入下一代种群.

        如果两个父代个体恰好为同一个，则直接进入下一代种群。

        子代中是否允许重复？允许。

    * 目标函数值可能为负数，无法直接生成累积概率，则无法应用轮盘赌的方式进行选择

        解决方法是让每一个个体的目标函数值都减去这一代中的最小目标函数，然后加个一个小的整数，本程序中为5。

        也尝试了取指数的方法，但是指数会使大的数变得更大，每隔个体所占比例相差很大，效果不好。

        这个过程一般称为标定，网上还有人提出动态标定的方法。

        由此思考到一个问题：遗传算法中采用的适应度函数，并不是我们要求的目标函数，可能需要对目标函数加以改造，变成符合要求的适应度函数，例如值始终为正。
    
    * 编程中遇到问题：变量为0时对应的目标函数值为0，与给定的函数不符

        查找原因：如果两个父代个体恰好为同一个，则直接进入下一代种群，这个时候应该用`continue`继续选取两个父代进行交叉，误用了`break`，导致子代个体不足。
    
    * 在不添加变异的时候，程序会很快稳定到一个局部最优解附近，无法继续优化

    * 变异方式的选择

        1. 每产生一个子代个体之后，用随机数和变异概率判断是否要进行变异；

        2. 在产生完整的下一代种群之后，随机选取一个进行变异。

        为了保证有较多的个体发生变异，从而跳出当前局部最优解，采用第一种方式。
    
    * 整体感觉

        1. 不需要计算梯度，计算速度较快；但是一般需要较大的种群和较多的代数，才能找到比较接近全局最优的解；

        2. 选取上一代中较好的个体进行交叉产生下一代，但是这个交叉过程没有依据，不一定能产生更好的个体；

        3. 在使用遗传算法的时候，也需要提前给出很多参数，类似于神经网络的超参数，例如种群个数、代数、交叉概率、变异概率；

        4. 遗传算法在编码、选择、交叉、变异、替换每一个步骤中，都有很多可选的方案；

* 航天动力学

    批改作业：

    第三题考虑顺行逆行两种轨道，并判断是否会撞上地球。